---
layout: post
title: Add custom attributes to magento SOAP API v1 and v2
date: 2014-09-20 20:46:33.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Magento
- PHP
- Soap
tags:
- custom attribute
- Magento
- PHP
- SOAP
meta:
  _edit_last: '44872122'
  geo_public: '0'
  _publicize_pending: '1'
author:
  login: lurajcevi
  email: traxdater12@gmail.com
  display_name: lurajcevi
  first_name: ''
  last_name: ''
---
<p><img src="{{ site.baseurl }}/assets/yellow-bar-soap.png" alt="Soap magento" /><br />
Sometimes a need arises for you to add additional attributes to the standard Magento API responses. While doing this in Mageno API v1 is fairly easy, as you will see soon, the v2 has some quirks that had to be found out the hard way, unfortunately. So in order for this to not happen again, here is the explanation.<!--more--></p>
<p>I will assume you already have your API roles set up, and you can invoke Magento API and get responses. We will test this functionality for the order info API call. Let's start with the API v1.</p>
<p>In order to connect and get the response for the individual order, you need to have code like this one:</p>
<p>[code language="php"]<br />
&lt;?php</p>
<p>include 'app/Mage.php';</p>
<p>try {<br />
$client = new SoapClient(Mage::getBaseUrl() . 'index.php/api/soap?wsdl=1', array('exceptions' =&gt; true, 'trace' =&gt; true));<br />
} catch (Exception $e) {<br />
header('HTTP/1.1 500');<br />
echo 'API unavailable.';<br />
exit;<br />
}<br />
$session = $client-&gt;login('ApiTest', 'test_key');</p>
<p>$result = $client-&gt;call($session, 'sales_order.info', '100015226');</p>
<p>echo &quot;&lt;pre&gt;&quot;;<br />
var_dump($result);<br />
echo &quot;&lt;/pre&gt;&quot;;</p>
<p>exit;<br />
[/code]</p>
<p>Save this in your root directory, and you can access it from browser.<br />
This will send a request to the Magento asking for the information about this specific order (ID: 100015226). Where does this request go? The answer is <strong>Mage_Sales_Model_Order_Api</strong> class, and its <strong>info</strong> method. We want a custom attribute. Lets add it to the very end of this method, but not in the core. Create a module, or use an existing one and override this class and method!<br />
[code language="php"]<br />
public function info($orderIncrementId)<br />
    {<br />
        $order = $this-&gt;_initOrder($orderIncrementId);</p>
<p>        if ($order-&gt;getGiftMessageId() &gt; 0) {<br />
            $order-&gt;setGiftMessage(<br />
                Mage::getSingleton('giftmessage/message')-&gt;load($order-&gt;getGiftMessageId())-&gt;getMessage()<br />
            );<br />
        }</p>
<p>        $result = $this-&gt;_getAttributes($order, 'order');</p>
<p>        $result['shipping_address'] = $this-&gt;_getAttributes($order-&gt;getShippingAddress(), 'order_address');<br />
        $result['billing_address']  = $this-&gt;_getAttributes($order-&gt;getBillingAddress(), 'order_address');<br />
        $result['items'] = array();</p>
<p>        foreach ($order-&gt;getAllItems() as $item) {<br />
            if ($item-&gt;getGiftMessageId() &gt; 0) {<br />
                $item-&gt;setGiftMessage(<br />
                    Mage::getSingleton('giftmessage/message')-&gt;load($item-&gt;getGiftMessageId())-&gt;getMessage()<br />
                );<br />
            }</p>
<p>            $result['items'][] = $this-&gt;_getAttributes($item, 'order_item');<br />
        }</p>
<p>        $result['payment'] = $this-&gt;_getAttributes($order-&gt;getPayment(), 'order_payment');</p>
<p>        $result['status_history'] = array();</p>
<p>        foreach ($order-&gt;getAllStatusHistory() as $history) {<br />
            $result['status_history'][] = $this-&gt;_getAttributes($history, 'order_status_history');<br />
        }</p>
<p>        $result['custom_attribute'] = 'CUSTOM VALUE';</p>
<p>        return $result;<br />
    }</p>
<p>[/code]</p>
<p>The second-to-last line is the modification. We've added a 'custom_attribute' key with the value of 'CUSTOM VALUE'. Refresh the API script and you should see the value returned along with the other information from the order.</p>
<p>[code language="jquery"]<br />
[&quot;custom_attribute&quot;]=&gt; string(12) &quot;CUSTOM VALUE&quot;<br />
[/code]</p>
<p>Excellent. We have modified the Magento api method and added our own attribute. Now off to the API v2.</p>
<p>API v2 has some changes in the way the methods are invoked. The script that connects and sends the request now looks like this:<br />
[code language="php"]<br />
&lt;?php</p>
<p>include 'app/Mage.php';</p>
<p>$proxy = new SoapClient(Mage::getBaseUrl() . 'index.php/api/v2_soap/?wsdl');</p>
<p>$sessionId = $proxy-&gt;login((object)array('username' =&gt; 'ApiTest', 'apiKey' =&gt; 'test_key'));</p>
<p>$result = $proxy-&gt;salesOrderInfo((object)array('sessionId' =&gt; $sessionId-&gt;result, 'orderIncrementId' =&gt; '100015226'));</p>
<p>echo &quot;&lt;pre&gt;&quot;;<br />
var_dump($result);<br />
echo &quot;&lt;/pre&gt;&quot;;</p>
<p>exit;<br />
[/code]</p>
<p>You can see that the order ID is the same, only the way the request is being sent is different. You should also go into the Magento admin System &gt; Configuration &gt; Magento Core Api and turn on the <strong>WS-I Compliance</strong> in order to work with v2 API.<br />
So after some configuration, refresh the page and see what happens. We have lost our 'custom_attribute'. What happened? Does Magento go to some other method in v2 of its API? No, it goes to the same one but it has another entry point: <strong>Mage_Sales_Model_Order_Api_V2</strong>. You should go and override this class and let it extend from your new <strong>Mage_Sales_Model_Order_Api</strong> one (ie. the one we created above). Refresh the call again. What? Nothing again? Come on...</p>
<p>Relax, we have one more thing to do. In order to make this work you should create additional files. Let's take a look into <strong>Mage/Sales/etc/wsdl.xml</strong> and <strong>Mage/Sales/etc/wsi.xml</strong>. Search for the salesOrderInfo in the wsdl.xml and you will find this:<br />
[code language="xml"]<br />
&lt;message name=&quot;salesOrderInfoRequest&quot;&gt;<br />
    &lt;part name=&quot;sessionId&quot; type=&quot;xsd:string&quot; /&gt;<br />
    &lt;part name=&quot;orderIncrementId&quot; type=&quot;xsd:string&quot; /&gt;<br />
&lt;/message&gt;<br />
&lt;message name=&quot;salesOrderInfoResponse&quot;&gt;<br />
    &lt;part name=&quot;result&quot; type=&quot;typens:salesOrderEntity&quot; /&gt;<br />
&lt;/message&gt;<br />
[/code]</p>
<p>The meaning is the following: our salesOrderInfo request message is expected to send sessionId and orderIncrementId, both of type string to Magento. If we look into our Api script above we notice that we have done that already:<br />
[code language="php"]<br />
$result = $proxy-&gt;salesOrderInfo((object)array('sessionId' =&gt; $sessionId-&gt;result, 'orderIncrementId' =&gt; '100015226'));<br />
[/code]</p>
<p>As for the response, as you can see in the xml above, Magento will return the <strong>salesOrderEntity</strong> type back. Let's look for the salesOrderEntity.<br />
[code language="xml"]<br />
&lt;complexType name=&quot;salesOrderEntity&quot;&gt;<br />
     &lt;all&gt;<br />
          &lt;element name=&quot;increment_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;parent_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;store_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;created_at&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;updated_at&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;is_active&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;customer_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;tax_amount&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_amount&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;discount_amount&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;subtotal&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;grand_total&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;total_paid&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;total_refunded&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;total_qty_ordered&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;total_canceled&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;total_invoiced&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;total_online_refunded&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;total_offline_refunded&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_tax_amount&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_shipping_amount&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_discount_amount&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_subtotal&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_grand_total&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_total_paid&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_total_refunded&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_total_qty_ordered&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_total_canceled&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_total_invoiced&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_total_online_refunded&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_total_offline_refunded&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;billing_address_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;billing_firstname&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;billing_lastname&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_address_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_firstname&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_lastname&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;billing_name&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_name&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;store_to_base_rate&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;store_to_order_rate&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_to_global_rate&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_to_order_rate&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;weight&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;store_name&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;remote_ip&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;status&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;state&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;applied_rule_ids&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;global_currency_code&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;base_currency_code&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;store_currency_code&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;order_currency_code&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_method&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_description&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;customer_email&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;customer_firstname&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;customer_lastname&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;quote_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;is_virtual&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;customer_group_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;customer_note_notify&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;customer_is_guest&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;email_sent&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;order_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;gift_message_id&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;gift_message&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;shipping_address&quot; type=&quot;typens:salesOrderAddressEntity&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;billing_address&quot; type=&quot;typens:salesOrderAddressEntity&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;items&quot; type=&quot;typens:salesOrderItemEntityArray&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;payment&quot; type=&quot;typens:salesOrderPaymentEntity&quot; minOccurs=&quot;0&quot; /&gt;<br />
          &lt;element name=&quot;status_history&quot; type=&quot;typens:salesOrderStatusHistoryEntityArray&quot; minOccurs=&quot;0&quot; /&gt;<br />
     &lt;/all&gt;<br />
&lt;/complexType&gt;<br />
[/code]</p>
<p>Wow, that's a big list. But we can easily see that it's elements match the response we got from the call. What Magento does is it simply looks into this file, and returns only the attributes listed here. A simple fix would be to add our own attribute into this list, and everything should be fine. But we should not do this in the core file, instead, we should create our own wsdl.xml file, because Magento merges all of his files into one big file. This way the core is not tampered and we have our functionality. So create a <strong>wsdl.xml</strong> in your module and in it put code like this one:<br />
 
{% highlight xml %}
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
&lt;definitions xmlns:typens=&quot;urn:{{var wsdl.name}}&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/wsdl/soap/&quot;<br />
    xmlns:soapenc=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:wsdl=&quot;http://schemas.xmlsoap.org/wsdl/&quot; xmlns=&quot;http://schemas.xmlsoap.org/wsdl/&quot;<br />
    name=&quot;{{var wsdl.name}}&quot; targetNamespace=&quot;urn:{{var wsdl.name}}&quot;&gt;<br />
    &lt;types&gt;<br />
        &lt;schema xmlns=&quot;http://www.w3.org/2001/XMLSchema&quot; targetNamespace=&quot;urn:Magento&quot;&gt;<br />
            &lt;import namespace=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; schemaLocation=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; /&gt;<br />
            &lt;complexType name=&quot;salesOrderEntity&quot;&gt;<br />
               &lt;all&gt;<br />
                    &lt;element name=&quot;custom_attribute&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
               &lt;/all&gt;<br />
            &lt;/complexType&gt;<br />
        &lt;/schema&gt;<br />
    &lt;/types&gt;<br />
&lt;/definitions&gt;<br />
{% endhighlight %}

</p>
<p>We have also mentioned <strong>wsi.xml</strong> file. This file also has a <strong>salesOrderEntity</strong> that we need to change. But also avoid the core changes, and create the file in your own module, and paste in it something like this:<br />
[code language="xml"]<br />
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
&lt;wsdl:definitions xmlns:typens=&quot;urn:{{var wsdl.name}}&quot;<br />
             xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;<br />
             xmlns:soap=&quot;http://schemas.xmlsoap.org/wsdl/soap/&quot;<br />
             xmlns:soapenc=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;<br />
             xmlns:wsdl=&quot;http://schemas.xmlsoap.org/wsdl/&quot;<br />
             name=&quot;{{var wsdl.name}}&quot;<br />
             targetNamespace=&quot;urn:{{var wsdl.name}}&quot;&gt;<br />
    &lt;wsdl:types&gt;<br />
        &lt;xsd:schema xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; targetNamespace=&quot;urn:{{var wsdl.name}}&quot;&gt;<br />
            &lt;xsd:complexType name=&quot;salesOrderEntity&quot;&gt;<br />
                &lt;xsd:sequence&gt;<br />
                    &lt;xsd:element name=&quot;custom_attribute&quot; type=&quot;xsd:string&quot; minOccurs=&quot;0&quot; /&gt;<br />
                   &lt;/xsd:sequence&gt;<br />
              &lt;/xsd:complexType&gt;<br />
         &lt;/xsd:schema&gt;<br />
    &lt;/wsdl:types&gt;<br />
&lt;/wsdl:definitions&gt;<br />
[/code]</p>
<p>Ok, if you refresh the API call once again, nothing happens. We have the same response. There is just one small thing we need to do (the thing that cost me a few hours at least).<br />
PHP is caching wsdl in a separate place (not Magento cache). On Linux operating system it is in <strong>/tmp</strong> folder. The files are the ones starting with the <strong>wsdl-</strong>. Delete all of them and refresh the script.<br />
Finally, we have our 'custom_attribute' in the response array. If you don't, try clearing your Magento cache, it helps sometimes ^^.</p>
