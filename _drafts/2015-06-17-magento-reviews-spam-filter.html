---
layout: post
title: Magento reviews spam filter
date: 2015-06-17 19:51:20.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Magento
- PHP
tags:
- filtering
- html
- javascript
- Magento
- review
- reviews
- spam
- spambot
meta:
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '11768784312'
  _edit_last: '44872122'
  geo_public: '0'
author:
  login: lurajcevi
  email: traxdater12@gmail.com
  display_name: lurajcevi
  first_name: ''
  last_name: ''
---
<p><a href="https://lurajcevi.files.wordpress.com/2015/06/stop-spam.jpg"><img class="alignnone size-medium wp-image-378" src="{{ site.baseurl }}/assets/stop-spam.jpg?w=300" alt="Stop-Spam" width="300" height="200" /></a><br />
"Out of the box" Magento has real issues when it comes to spam, be it customers or reviews. There is no filtering, no checking for spambots in any way. Only one thing is required - that all data should be entered in the form fields.<br />
This is piece of cake for almost any spambot out there. Visit the site, find the form, fill in all the fields with the appropriate values, submit the form, <em>et voila:</em> your list of pending reviews will be so long, you will just do "select all - delete" combo. It is really annoying.</p>
<p>Fortunately, we can work around this, and create our own spam filter. With some javascript code, and a backend validation, all the hard work spambots are doing will be in vain, and we will come out as victors in the end. :)<br />
<!--more--></p>
<p>What is the idea? Well, since many spambots disable javascript while doing their evil deeds, we'll just have to make sure our form contains something rendered with javascript.</p>
<p>Magento reviews: simple form, few fields, all of which have to be populated. Template for this is at <em>template/review/form.phtml</em>.</p>
<p>By adding some javascript and 2 hidden fields, we can get rid of almost all spambots.</p>
<p>Take a look at this:</p>
<p>[code language="html"]<br />
 &lt;!-- HIDDEN FIELD FOR SPAMBOTS --&gt;<br />
 &lt;li&gt;<br />
   &lt;input type=&quot;text&quot; name=&quot;spambait&quot; id=&quot;spambait&quot;<br />
          class=&quot;spambait&quot; value=&quot;&quot;<br />
          autocomplete=&quot;off&quot;/&gt;<br />
 &lt;/li&gt;<br />
[/code]</p>
<p>[code language="javascript"]<br />
&lt;script type=&quot;text/javascript&quot;&gt;<br />
    // js logic for spambot input fields<br />
    var form = $('review-form');<br />
    var track = $('spambait');<br />
    var track2 = track.cloneNode(true);<br />
    track.hide();<br />
    track2.setAttribute('name','spambait'+'_track_'+(1+1))<br />
    track2.setAttribute('value','earth');<br />
    track2.setAttribute('id', &quot;&quot;);<br />
    track2.hide();<br />
    track.insert({'after': track2});<br />
&lt;/script&gt;<br />
[/code]</p>
<p>This is the code we need to add to our form. First part (HTML) goes inside the form (at the end, or where ever you prefer it). Javascript, on the other hand, goes outside the form (obviously), near the already existing javascript code in the same file.<br />
What does it do? Simply, it grabs a reference to the already existing field, clones it, hides it and adds some attributes. Name is generated by concatenating strings and addition of 2 numbers (in case there is a really nasty spambot that does code analysis and deduces what we are trying to do, hopefully it will not do an <strong><em>eval()</em></strong> on our code). Value could be some arbitrary value - not that important, and id should be empty.</p>
<p>When we refresh our page, nothing happened. Everything is working like it should. If you fill your form, it would be submitted, and all is great. But when a spambot comes, he will populate all the fields and "BAM - gotcha!!" (after we implemet backend validation, of course).</p>
<p>Magento already has a place where it does its backend validation: <strong><em>Mage_Review_ProductController</em> </strong> class and its method <strong><em>postAction()</em></strong>, but is merely checking if fields have value in them. Lame. Let's change this.</p>
<p>Of course, any changes to the core folder cause Magento to stop working, all your orders get deleted, all your customers vanish and all your friends die. So, overwrite this class properly and make changes in your own module.</p>
<p>Change is fairly simple, all we need to do is add proper checks for the form fields we added above:</p>
<p>[code language="php"]<br />
if (($product = $this-&gt;_initProduct()) &amp;&amp; !empty($data)) {<br />
     // &lt;default_Magento&gt;<br />
     $session    = Mage::getSingleton('core/session');<br />
     /* @var $session Mage_Core_Model_Session */<br />
     $review     = Mage::getModel('review/review')-&gt;setData($data);<br />
     /* @var $review Mage_Review_Model_Review */</p>
<p>     $validate = $review-&gt;validate();<br />
     // &lt;/default_Magento&gt;</p>
<p>     // Our code<br />
     // Check if spambait caught something<br />
     if (!isset($data['spambait']) || $data['spambait'] != &quot;&quot;) {<br />
         $validate = false;<br />
     }<br />
     if (!isset($data['spambait_track_2']) || $data['spambait_track_2'] != &quot;earth&quot;) {<br />
         $validate = false;<br />
     }<br />
     ...<br />
     ...<br />
[/code]</p>
<p>If we catch something, validation will be <em>false</em>, otherwise, like nothing happened.<br />
Do not let yourself or your store get bullied. Fight back!</p>
<p>Cheers.</p>
