---
layout: post
title: Search in this category functionality - Magento
date: 2014-07-04 10:13:25.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Magento
- PHP
tags:
- Magento
- PHP
- search
meta:
  _publicize_pending: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _wpas_skip_facebook: '1'
  _wpas_skip_google_plus: '1'
  _wpas_skip_twitter: '1'
  _wpas_skip_linkedin: '1'
  _wpas_skip_tumblr: '1'
  _wpas_skip_path: '1'
  _edit_last: '44872122'
  geo_public: '0'
author:
  login: lurajcevi
  email: traxdater12@gmail.com
  display_name: lurajcevi
  first_name: ''
  last_name: ''
---
<p>Magento search query, when entered in the <code>form.mini.phtml</code> (<code>template/catalogsearch/form.mini.phtml</code>) is doing the search on database in <code>Mage_CatalogSearch_Model_Layer:prepareProductCollection()</code>.</p>
<p>In order to do search only in a specific category, you can add your filter in here.</p>
<p><!--more--></p>
<pre class="code php"><span class="kw2">public</span> <span class="kw2">function</span> prepareProductCollection<span class="br0">(</span><span class="re0">$collection</span><span class="br0">)</span>
    <span class="br0">{</span>
        <span class="re0">$collection</span>
            <span class="sy0">-&gt;</span><span class="me1">addAttributeToSelect</span><span class="br0">(</span>Mage<span class="sy0">::</span><span class="me2">getSingleton</span><span class="br0">(</span><span class="st_h">'catalog/config'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">getProductAttributes</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span>
            <span class="sy0">-&gt;</span><span class="me1">addSearchFilter</span><span class="br0">(</span>Mage<span class="sy0">::</span><span class="me2">helper</span><span class="br0">(</span><span class="st_h">'catalogsearch'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">getQuery</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">getQueryText</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span>
            <span class="sy0">-&gt;</span><span class="me1">setStore</span><span class="br0">(</span>Mage<span class="sy0">::</span><span class="me2">app</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">getStore</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span>
            <span class="sy0">-&gt;</span><span class="me1">addMinimalPrice</span><span class="br0">(</span><span class="br0">)</span>
            <span class="sy0">-&gt;</span><span class="me1">addFinalPrice</span><span class="br0">(</span><span class="br0">)</span>
            <span class="sy0">-&gt;</span><span class="me1">addTaxPercents</span><span class="br0">(</span><span class="br0">)</span>
            <span class="sy0">-&gt;</span><span class="me1">addStoreFilter</span><span class="br0">(</span><span class="br0">)</span>
            <strong><span class="sy0">-&gt;</span></strong><span class="me1">addCategoryFilter</span><span class="br0">(</span><span class="re0">$categoryFilter</span><span class="br0">)</span>
            <span class="sy0">-&gt;</span><span class="me1">addUrlRewrite</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
Â 
        Mage<span class="sy0">::</span><span class="me2">getSingleton</span><span class="br0">(</span><span class="st_h">'catalog/product_status'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">addVisibleFilterToCollection</span><span class="br0">(</span><span class="re0">$collection</span><span class="br0">)</span><span class="sy0">;</span>
        Mage<span class="sy0">::</span><span class="me2">getSingleton</span><span class="br0">(</span><span class="st_h">'catalog/product_visibility'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">addVisibleInSearchFilterToCollection</span><span class="br0">(</span><span class="re0">$collection</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="re0">$this</span><span class="st_h">''


</span></pre>
<p>$categoryFilter can be found when submitting the form. For example, you can add this to the form.mini.phtml</p>
<pre>$catalogSearchHelper = $this-&gt;helper('catalogsearch');
$categoryFilter = Mage::helper('catalogsearch')-&gt;getSelectedCategory();
$currentCategory = Mage::registry('current_category');
if ($currentCategory) {
  $categoryName = $currentCategory-&gt;getUrlKey();
} else if ($categoryFilter) {
  $categoryName = $categoryFilter-&gt;getUrlKey();
} else {
  $categoryName = "";
}
...
...
&lt;div class="category-search"&gt;
  &lt;input type="checkbox" name="category_search" value="&lt;?php echo $categoryName; ?&gt;"&gt;
  &lt;label for="category_search"&gt;
    &lt;?php echo $this-&gt;__(' Search in this category only') ?&gt;
  &lt;/label&gt;
&lt;/div&gt;</pre>
<p>Then create a Helper for CatalogSearch that can get categoryName:</p>
<pre>public function getSelectedCategory()
 {
   $categoryName = Mage::app()-&gt;getRequest()-&gt;getParam('category_search');
   $category = Mage::getModel('catalog/category')-&gt;loadByAttribute('url_key', $categoryName);
   return $category;
 }</pre>
<p>And lastly, grab the category id and put it in your Layer.php file</p>
<pre> $categoryFilter = Mage::helper('catalogsearch')-&gt;getSelectedCategory();</pre>
